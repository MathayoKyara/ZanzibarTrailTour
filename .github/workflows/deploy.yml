name: Deploy Flutter Web to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.22.0'
          channel: 'stable'

      - name: Get dependencies
        run: flutter pub get

      - name: Build web
        run: flutter build web --release --base-href "/ZanzibarTrailTour/"

      - name: Fix base href in index.html
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          INDEX_FILE="build/web/index.html"
          echo "Repository name: $REPO_NAME"
          echo "Fixing base href in index.html..."
          if [ -f "$INDEX_FILE" ]; then
            # Try multiple patterns to ensure we catch all variations
            sed -i "s|<base href=\"/\">|<base href=\"/${REPO_NAME}/\">|g" "$INDEX_FILE"
            sed -i "s|<base href='/'>|<base href=\"/${REPO_NAME}/\">|g" "$INDEX_FILE"
            sed -i "s|<base href=\"\/\">|<base href=\"/${REPO_NAME}/\">|g" "$INDEX_FILE"
            echo "✓ Base href fixed successfully"
            echo "Verifying base href fix:"
            grep -n "base href" "$INDEX_FILE" || echo "Base href not found in index.html"
            # Double-check it was actually changed
            if grep -q "<base href=\"/\">" "$INDEX_FILE"; then
              echo "⚠ WARNING: Base href still shows '/', trying alternative fix..."
              sed -i "s|<base href=\"/\">|<base href=\"/${REPO_NAME}/\">|" "$INDEX_FILE"
              grep -n "base href" "$INDEX_FILE"
            fi
          else
            echo "✗ Error: index.html not found at $INDEX_FILE"
            exit 1
          fi

      - name: Add 404.html for SPA routing
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          # Copy index.html to 404.html so client-side routing works on GitHub Pages
          if [ -f "build/web/index.html" ]; then
            cp build/web/index.html build/web/404.html
            echo "✓ Created 404.html from index.html for SPA routing"
            echo "This ensures client-side routes work correctly on GitHub Pages"
          else
            echo "✗ Error: index.html not found, cannot create 404.html"
            exit 1
          fi

      - name: Verify build output
        run: |
          if [ ! -f "build/web/index.html" ]; then
            echo "Error: index.html not found in build/web"
            exit 1
          fi
          echo "Build output verified successfully"
          echo "=== Files in build/web ==="
          ls -la build/web/ | head -30
          echo "=== Checking index.html content ==="
          head -20 build/web/index.html
          echo "=== Verifying base href is correct ==="
          grep "base href" build/web/index.html
          echo "=== File sizes ==="
          du -sh build/web/*
          echo "=== Total build size ==="
          du -sh build/web

      - name: Create .nojekyll file
        run: |
          echo "Creating .nojekyll file to prevent Jekyll processing..."
          touch build/web/.nojekyll
          echo "" > build/web/.nojekyll
          echo "✓ Created .nojekyll file"
          if [ -f "build/web/.nojekyll" ]; then
            echo "✓ Verified .nojekyll exists"
            ls -la build/web/.nojekyll
          else
            echo "✗ ERROR: .nojekyll file creation failed!"
            exit 1
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Final verification before upload
        run: |
          echo "=== FINAL VERIFICATION ==="
          echo "=== Files to be uploaded ==="
          find build/web -type f | head -30
          echo ""
          echo "=== Checking for index.html ==="
          if [ -f "build/web/index.html" ]; then
            echo "✓ index.html exists"
            echo "=== Verifying base href in index.html ==="
            BASE_HREF_LINE=$(grep "base href" build/web/index.html || echo "NOT FOUND")
            echo "Base href line found: $BASE_HREF_LINE"
            if echo "$BASE_HREF_LINE" | grep -q "/ZanzibarTrailTour/"; then
              echo "✓ Base href is CORRECT: /ZanzibarTrailTour/"
            else
              echo "✗ ERROR: Base href is WRONG! Expected /ZanzibarTrailTour/ but found: $BASE_HREF_LINE"
              echo "Attempting emergency fix..."
              sed -i 's|<base href="[^"]*">|<base href="/ZanzibarTrailTour/">|' build/web/index.html
              sed -i "s|<base href='/'>|<base href=\"/ZanzibarTrailTour/\">|" build/web/index.html
              sed -i "s|<base href=\"/\">|<base href=\"/ZanzibarTrailTour/\">|" build/web/index.html
              echo "After fix:"
              grep "base href" build/web/index.html
            fi
          else
            echo "✗ index.html NOT FOUND"
            exit 1
          fi
          echo ""
          echo "=== Checking for .nojekyll ==="
          if [ -f "build/web/.nojekyll" ]; then
            echo "✓ .nojekyll exists"
          else
            echo "✗ .nojekyll NOT FOUND - creating now..."
            touch build/web/.nojekyll
            echo "" > build/web/.nojekyll
          fi
          echo ""
          echo "=== Checking for 404.html ==="
          if [ -f "build/web/404.html" ]; then
            echo "✓ 404.html exists"
          else
            echo "✗ 404.html NOT FOUND"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './build/web'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

